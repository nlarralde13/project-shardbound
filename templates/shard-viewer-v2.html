<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shard Viewer v2</title>

  <!-- Base styles + v2 overlay styles -->
  <link rel="stylesheet" href="/static/css/shard-viewer.css" />
  <link rel="stylesheet" href="/static/css/shard-viewer-v2.css" />

  <!-- Prefer grid as the canonical biome source; renderer may fallback to tiles -->
  <script>
    window.SHARDBIOME_SOURCE = 'grid';
  </script>

  <!-- Small add-on styles for v2 controls (non-invasive) -->
  <style>
    .group h3 { display:flex; align-items:center; gap:.5rem; }
    .tag { font: 600 11px/1 ui-sans-serif,system-ui; padding:.2rem .4rem; border-radius:6px; background:#eef; color:#334; }
    .row.inline-3 > * { min-width: 0; }
    .muted.small { font-size: 12px; opacity: .8; }
    .kbd { font: 600 11px/1 ui-monospace,Menlo,Consolas; background:#222; color:#fff; padding:2px 6px; border-radius:6px; }
    .overlay-chip { font:600 10px/1 ui-sans-serif; padding:.2rem .35rem; border-radius:999px; background:#eee; color:#333; }
    .debug-badge { position:absolute; right:10px; top:10px; z-index:2500; background:rgba(17,24,39,.9); color:#cbd5e1; border:1px solid #334155; border-radius:8px; padding:6px 8px; font:12px ui-monospace,Menlo,Consolas; pointer-events:none; transition:opacity .2s ease; max-width:42ch; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    /* Context menu for v2 */
    .ctx-menu, .ctx-submenu { position:fixed; background:#fff; color:#111; border:1px solid #cbd5e1; border-radius:8px; padding:6px; box-shadow:0 10px 30px rgba(0,0,0,.18); z-index:3000; min-width:180px; }
    .ctx-submenu { min-width:220px; }
    .ctx-item { display:block; width:100%; text-align:left; padding:8px 10px; border:none; background:transparent; border-radius:6px; font:13px system-ui; cursor:pointer; }
    .ctx-item:hover, .ctx-item:focus { outline:none; background:#eef6ff; }
    .ctx-sep { height:1px; margin:6px 2px; background:#e5e7eb; }
  </style>
</head>
<body>
  <header><h1>Shard Viewer <span class="tag">v2</span></h1></header>

  <main class="wrap">
    <!-- LEFT: Load + Viewer + V2 Controls -->
    <aside class="card pane-left">
      <h2>Load / Generate</h2>
      <section>
        <!-- loader -->
        <div class="row">
          <label>Shard</label>
          <select id="shardSelect"></select>
        </div>
        <div class="row">
          <label></label>
          <button id="btnLoad">Load</button>
        </div>
        <div class="row">
          <label></label>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <button id="btnSaveDraft" class="btn-warning" title="Apply draft, validate, and save local snapshot">Save Draft</button>
            <button id="btnPushLive" class="btn-success is-dim" title="Persist current shard to disk via API" disabled>Push Live</button>
            <button id="btnUndoToSave" class="secondary" title="Revert to the last load/save baseline">Undo to Save</button>
          </div>
        </div>

        <div class="group">
          <h3>Viewer</h3>
          <div class="row"><label>Scale (px/tile)</label><input id="scale" type="number" min="1" max="64" value="8" /></div>
          <div class="row"><label>Show grid</label><input id="grid" type="checkbox" checked /></div>
          <div class="row"><label>Auto-fit</label><input id="autoFit" type="checkbox" checked /></div>
          <div class="row"><label>CRT scanlines</label><input id="crtMode" type="checkbox" /></div>
          <div class="row">
            <label>Overlay opacity</label>
            <input id="overlayOpacity" type="range" min="0" max="100" value="85" />
          </div>
          <div class="row">
            <label>Palette</label>
            <select id="palette">
              <option value="classic">Classic</option>
              <option value="contrast">High Contrast</option>
              <option value="pastel">Pastel</option>
              <option value="noir">Noir</option>
            </select>
          </div>
          <div class="muted" id="status" aria-live="polite">Ready.</div>
          <div class="muted small">Tip: hold <span class="kbd">Alt</span> to temporarily hide overlays while dragging.</div>
        </div>

        <!-- Layers -->
        <div class="group">
          <h3>Layers <span class="overlay-chip">v2</span></h3>
          <div class="row inline-3">
            <div><label>Biomes</label><input id="layerBiomes" type="checkbox" checked /></div>
            <div><label>Infrastructure</label><input id="layerInfra" type="checkbox" checked /></div>
            <div><label>Settlements</label><input id="layerSettlements" type="checkbox" /></div>
          </div>
          <div class="row inline-3">
            <div style="display:flex;align-items:center;gap:6px"><label>Shardgates</label><input id="layerShardgates" type="checkbox" checked /></div>
            <div></div>
            <div></div>
          </div>
        </div>

        <!-- Plan / Generate -->
        <div class="group">
          <h3>Plan <span class="overlay-chip">/api/shard-gen-v2/plan</span></h3>
          
            <div style="display:flex;gap:8px;align-items:center">
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button id="btnPlanV2" class="secondary">Plan</button>
                <button id="btnGenerateV2">Generate</button>
              </div>
            </div>
        </div>
           <div class="row">
            <label></label>
            
               
         
          <pre class="muted small" id="planOut" style="max-height:140px;overflow:auto;"></pre>
        </div>

      </section>
    </aside>

    <div class="gutter" id="gutter" role="separator" aria-orientation="vertical" aria-label="Resize sidebar" tabindex="0"></div>

    <!-- RIGHT: Canvas Viewer -->
    <section class="card viewer">
      <h2>Map</h2>
      <section class="canvas-wrap" id="frame">
        <canvas id="canvas"></canvas>
        <div class="tooltip" id="tooltip"></div>
        <div class="debug-badge" id="debugBadge" aria-live="polite" style="opacity:0"></div>
        <div class="zoomOverlay">
          <button class="zbtn" id="btnFit" title="Fit (refit)">⤢</button>
          <button class="zbtn" id="btnZoomIn" title="Zoom in">+</button>
          <button class="zbtn" id="btnZoomOut" title="Zoom out">−</button>
        </div>
      </section>
      <section>
        <h3>Activity Log</h3>
        <pre id="actionLog" class="muted small" style="max-height:220px; overflow:auto; background:#0b1228; color:#dbeafe; border:1px solid #2a3a62; border-radius:8px; padding:8px; white-space:pre-wrap"></pre>
        <div style="display:flex; gap:8px; margin-top:6px">
          <button id="btnClearLog" class="secondary">Clear Log</button>
        </div>
      </section>
    </section>

    <!-- FAR RIGHT: Tile Info Panel -->
    <aside class="card pane-right" id="tileInfoPanel">
      <h2>Tile Info</h2>
      <section>
        <div class="row"><label>Coords</label><input id="tileCoord" type="text" readonly value="-,-" /></div>
        <div class="row auto">
          <label class="muted">Raw Tile JSON</label>
          <textarea id="tileJson" style="width:100%; min-height:260px; font:12px ui-monospace,Menlo,Consolas; background:#0b1228; color:#dbeafe; border:1px solid #2a3a62; border-radius:8px; padding:8px;" placeholder="Click a tile to view/edit raw JSON" ></textarea>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
          <button id="btnTileApply" class="secondary" title="Apply edits to the in‑memory draft">Apply</button>
          <button id="btnTileValidate">Validate</button>
          <button id="btnTilePush" class="primary" disabled>Push Live</button>
        </div>
        <pre id="tileContext" class="muted small" style="max-height:160px; overflow:auto; border:1px dashed #2a3a62; padding:8px; border-radius:8px; background:#081021"></pre>
        <pre id="tileValidateOut" class="muted small" style="white-space:pre-wrap"></pre>
      </section>
    </aside>
  </main>

  <!-- Minimal bootstrap (seed toggle + quick plan preview) -->
  <script type="module">
    const v2AutoSeed = document.getElementById('v2AutoSeed');
    const v2Seed     = document.getElementById('v2Seed');
    const planOut    = document.getElementById('planOut');
    const v2POIBudget= document.getElementById('v2POIBudget');
    const v2Template = document.getElementById('v2Template');
    const v2Name     = document.getElementById('v2Name');
    const v2BiomePack= document.getElementById('v2BiomePack');
    const btnPlanV2  = document.getElementById('btnPlanV2');

    if (v2AutoSeed && v2Seed) {
      const sync = () => v2Seed.toggleAttribute('disabled', v2AutoSeed.checked);
      v2AutoSeed.addEventListener('change', sync); sync();
    }

    async function callPlan() {
      const body = {
        templateId: v2Template?.value || 'normal-16',
        name: (v2Name?.value || 'blue_coast'),
        autoSeed: v2AutoSeed?.checked,
        seed: v2AutoSeed?.checked ? undefined : Number(v2Seed?.value || 0),
        overrides: { poi: { budget: Number(v2POIBudget?.value || 0) } },
        biomePack: v2BiomePack?.value || undefined
      };
      try {
        const res = await fetch('/api/shard-gen-v2/plan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const json = await res.json();
        planOut.textContent = JSON.stringify({
          ok: json.ok, plan_id: json.plan_id, seed: json?.provenance?.seed,
          water: json?.layers?.water, hydrology: json?.layers?.hydrology?.chosen
        }, null, 2);
      } catch (e) {
        planOut.textContent = String(e);
      }
    }
    btnPlanV2?.addEventListener('click', (e) => { e.preventDefault(); callPlan(); });

    // Progressive enhancement: load v2 overlay code (cache-busted in dev)
    import('/static/js/shard-viewer-v2.js?v=debug3').catch((e) => { console.error('[SV2] module import error', e); });
  </script>
</body>
</html>
