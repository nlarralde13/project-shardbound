<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>API Playground • Shardbound</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f1115; --panel: #161a22; --muted: #98a2b3; --text: #e6e8ea; --accent: #62d4ff;
      --ok: #7dd27d; --bad: #e57373; --warn: #f8c147;
    }
    html, body { height: 100%; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; display: grid; gap: 16px; }
    .top { display: flex; gap: 12px; align-items: center; }
    h1 { font-size: 18px; margin: 0; }
    .card { background: var(--panel); border: 1px solid #202634; border-radius: 10px; padding: 14px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom:6px; }
    input, select, textarea, button {
      background: #0f141d; color: var(--text); border: 1px solid #2a3140; border-radius: 8px; padding: 8px 10px; width: 100%;
    }
    textarea { min-height: 160px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    button { width: auto; cursor: pointer; }
    .muted { color: var(--muted); }
    .flex { display:flex; gap:8px; align-items:center; flex-wrap: wrap;}
    pre { background: #0c0f15; border: 1px solid #1d2331; color: #cfe3ff; padding: 10px; border-radius: 8px; overflow: auto; font-size: 12px; }
    .chips { display:flex; flex-wrap: wrap; gap:6px; }
    .chip { font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #2a3140; background:#121720;}
    .ok { color: var(--ok); } .bad { color: var(--bad); } .warn { color: var(--warn); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>API Playground</h1>
      <span class="muted">Quickly call your endpoints with canonical biomes & settlement types</span>
    </div>

    <section class="card row">
      <div>
        <h3 class="muted" style="margin-top:0;">List Shards</h3>
        <div class="flex">
          <button id="btnList">GET /api/shards</button>
          <button id="btnOpen">Open in Shard Viewer</button>
        </div>
        <pre id="listOut">// results here</pre>
      </div>

      <div>
        <h3 class="muted" style="margin-top:0;">Get One</h3>
        <div class="flex">
          <input id="getName" placeholder="nameNoExt (e.g. 12345678_shard_fire_island)" />
          <button id="btnGet">GET /api/shards/&lt;nameNoExt&gt;</button>
        </div>
        <pre id="getOut">// shard JSON here</pre>
      </div>
    </section>

    <section class="card">
      <h3 class="muted" style="margin-top:0;">Generate Shard (POST /api/generate_shard)</h3>
      <div class="row">
        <div>
          <label>Seed (8 digits)</label>
          <input id="seed" placeholder="e.g. 24681357" />
          <label>Width × Height</label>
          <div class="flex">
            <input id="width" placeholder="64" style="max-width:110px" />
            <input id="height" placeholder="64" style="max-width:110px" />
          </div>
          <label>Landmass Ratio</label>
          <input id="land" placeholder="0.50" />
          <div style="height:8px"></div>
          <label class="muted">Volcano</label>
          <div class="flex">
            <select id="volEnabled" style="max-width:130px">
              <option value="false">Disabled</option>
              <option value="true">Enabled</option>
            </select>
            <input id="volMin" placeholder="min radius (2)" style="max-width:150px" />
            <input id="volMax" placeholder="max radius (4)" style="max-width:150px" />
          </div>
          <label class="muted">Ports / Settlements</label>
          <div class="flex">
            <input id="ports" placeholder="ports count (0)" style="max-width:160px" />
            <input id="towns" placeholder="settlements count (0)" style="max-width:200px" />
          </div>
        </div>
        <div>
          <label>Allowed Biomes (canonical)</label>
          <div id="biomeChips" class="chips"></div>
          <label style="margin-top:8px;">Payload</label>
          <textarea id="payload"></textarea>
          <div class="flex">
            <button id="btnGen">POST /api/generate_shard</button>
            <span id="genStatus" class="muted"></span>
          </div>
        </div>
      </div>
      <pre id="genOut">// server response here</pre>
    </section>
  </div>

  <script type="module">
    import { ALL_BIOME_KEYS } from "/static/js/biomeRegistry.js";
    import { ALL_SETTLEMENT_KEYS } from "/static/js/settlementRegistry.js";

    // ===== Helpers
    const $ = (id) => document.getElementById(id);
    const listOut = $('listOut'), getOut = $('getOut'), genOut = $('genOut'), genStatus = $('genStatus');

    function setOut(el, obj){ el.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2); }

    async function doList(){
      const r = await fetch('/api/shards'); setOut(listOut, await r.json());
      window.__lastList = await (await fetch('/api/shards')).json();
    }
    async function doGet(){
      const name = $('getName').value.trim();
      const r = await fetch(`/api/shards/${encodeURIComponent(name)}`); setOut(getOut, await r.json());
    }

    // ===== Biome chips for generator payload
    const chosen = new Set(ALL_BIOME_KEYS); // default: allow all
    function drawBiomeChips(){
      const host = $('biomeChips'); host.innerHTML = '';
      ALL_BIOME_KEYS.forEach(k => {
        const btn = document.createElement('button');
        btn.className = 'chip';
        btn.textContent = chosen.has(k) ? `✓ ${k}` : k;
        btn.style.opacity = chosen.has(k) ? '1' : '.55';
        btn.addEventListener('click', () => { if (chosen.has(k)) chosen.delete(k); else chosen.add(k); drawBiomeChips(); buildPayload(); });
        host.appendChild(btn);
      });
    }

    function buildPayload(){
      const seed = $('seed').value.trim();
      const width = parseInt($('width').value || '64', 10);
      const height = parseInt($('height').value || '64', 10);
      const land = parseFloat($('land').value || '0.5');
      const volEnabled = $('volEnabled').value === 'true';
      const volMin = parseInt($('volMin').value || '2', 10);
      const volMax = parseInt($('volMax').value || '4', 10);
      const ports = parseInt($('ports').value || '0', 10);
      const towns = parseInt($('towns').value || '0', 10);

      const payload = {
        seed,
        width, height,
        landmass_ratio: isFinite(land) ? land : 0.5,
        biomes: Array.from(chosen), // canonical keys only
        volcano: { enabled: volEnabled, min_radius: volMin, max_radius: volMax },
        ports: { count: ports },
        settlements: { count: towns }
      };
      $('payload').value = JSON.stringify(payload, null, 2);
    }

    async function doGen(){
      const body = $('payload').value.trim();
      let parsed;
      try { parsed = JSON.parse(body || '{}'); }
      catch(e) { genStatus.textContent = 'Invalid JSON'; genStatus.className='bad'; return; }

      genStatus.textContent = 'Sending…'; genStatus.className='muted';
      const r = await fetch('/api/generate_shard', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(parsed) });
      const out = await r.json(); setOut(genOut, out);
      if (r.ok) { genStatus.textContent = 'OK'; genStatus.className='ok'; await doList(); }
      else { genStatus.textContent = 'Error'; genStatus.className='bad'; }
    }

    $('btnList').addEventListener('click', doList);
    $('btnGet').addEventListener('click', doGet);
    $('btnOpen').addEventListener('click', () => { window.location.href = '/shard-viewer'; });

    $('seed').addEventListener('input', buildPayload);
    $('width').addEventListener('input', buildPayload);
    $('height').addEventListener('input', buildPayload);
    $('land').addEventListener('input', buildPayload);
    $('volEnabled').addEventListener('change', buildPayload);
    $('volMin').addEventListener('input', buildPayload);
    $('volMax').addEventListener('input', buildPayload);
    $('ports').addEventListener('input', buildPayload);
    $('towns').addEventListener('input', buildPayload);
    $('btnGen').addEventListener('click', doGen);

    // init
    drawBiomeChips(); buildPayload();
    doList();
  </script>
</body>
</html>
