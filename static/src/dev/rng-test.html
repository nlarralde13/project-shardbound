<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ProjectMMO RNG Test Harness</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #0b0f14; --panel: #121821; --muted: #98a2b3; --fg: #e5e7eb;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Liberation Mono", monospace;
      --sans: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    html, body { margin:0; height:100%; background:var(--bg); color:var(--fg); font-family:var(--sans); }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 20px; }
    h1 { font-size: 20px; margin: 0 0 8px; font-weight: 600; }
    h2 { font-size: 16px; margin: 18px 0 10px; font-weight: 600; color:#cbd5e1; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .panel { background: var(--panel); border: 1px solid #1e293b; border-radius: 12px; padding: 14px; }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
    input[type="number"], input[type="text"], select {
      width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid #233044; background: #0d1320; color: var(--fg);
      font-family: var(--mono);
    }
    .controls { display:grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
    .btns { display:flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    button { background: #0f172a; border: 1px solid #233044; color: var(--fg); padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    button.primary { background: #1d4ed8; border-color: #1d4ed8; }
    pre { background: #0d1320; border: 1px solid #233044; border-radius: 8px; color: #e2e8f0; padding: 10px; overflow:auto; font-family: var(--mono); font-size: 12px; line-height: 1.5; white-space: pre-wrap; }
    canvas { image-rendering: pixelated; background:#000; border:1px solid #233044; border-radius:8px; }
    .muted { color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ProjectMMO RNG Test Harness</h1>
    <div class="panel">
      <div class="controls">
        <div><label>World Seed</label><input id="worldSeed" type="number" value="12345"></div>
        <div><label>Shard ID</label><input id="shardID" type="text" value="A_0"></div>
        <div><label>Tile X</label><input id="tileX" type="number" value="42"></div>
        <div><label>Tile Y</label><input id="tileY" type="number" value="17"></div>
        <div><label>Algorithm</label>
          <select id="algo">
            <option value="mulberry32" selected>mulberry32 (default)</option>
            <option value="xoshiro128ss">xoshiro128**</option>
          </select>
        </div>
        <div><label>Noise Frequency</label><input id="freq" type="number" step="0.05" min="0.05" max="4" value="0.35"></div>
      </div>
      <div class="btns">
        <button id="run" class="primary">Run Tests</button>
        <button id="noise">Render Noise</button>
      </div>
    </div>

    <div class="row" style="margin-top:14px;">
      <div class="panel">
        <h2>Results</h2>
        <pre id="log"></pre>
      </div>
      <div class="panel">
        <h2>Noise Preview</h2>
        <canvas id="noiseCanvas" width="256" height="256"></canvas>
        <div class="muted">Grayscale value-noise from <code>noise2D()</code>.</div>
      </div>
    </div>
  </div>

  <script type="module">
    const logEl = document.getElementById('log');
    const cvs = document.getElementById('noiseCanvas');
    const ctx = cvs.getContext('2d', { willReadFrequently: true });

    function log(...args){ logEl.textContent += args.join(' ') + '\\n'; }
    function clear(){ logEl.textContent = ''; }

    async function importRNG() {
      const paths = [
        '/static/src/utils/rng.js',   // typical static root
        '../src/utils/rng.js',        // if opened under /static/dev/
        '../../src/utils/rng.js',     // if nested differently
        '/src/utils/rng.js'           // dev servers that mount /src at root
      ];
      let lastErr;
      for (const p of paths) {
        try { return await import(p); }
        catch (e) { lastErr = e; }
      }
      throw lastErr || new Error('Could not import rng.js from any known path.');
    }

    function renderNoise(noise2D, baseSeed, freq){
      const w = cvs.width, h = cvs.height;
      const img = ctx.getImageData(0,0,w,h);
      const data = img.data;
      let i=0;
      for (let y=0; y<h; y++){
        for (let x=0; x<w; x++){
          const v = noise2D(x, y, baseSeed, freq); // 0..1
          const c = (v*255)|0;
          data[i++] = c; data[i++] = c; data[i++] = c; data[i++] = 255;
        }
      }
      ctx.putImageData(img,0,0);
    }

    async function run() {
      clear();
      const worldSeed = +document.getElementById('worldSeed').value;
      const shardID   = document.getElementById('shardID').value;
      const x         = +document.getElementById('tileX').value | 0;
      const y         = +document.getElementById('tileY').value | 0;
      const algo      = document.getElementById('algo').value;
      const freq      = +document.getElementById('freq').value;

      const rng = await importRNG();
      const { RNG, hash2, makeTileRNG, noise2D } = rng;

      const baseSeed = hash2(worldSeed, shardID, x, y);
      log('Inputs:', JSON.stringify({ worldSeed, shardID, x, y, algo, freq }));
      log('baseSeed:', baseSeed);

      const r1 = new RNG(baseSeed, algo);
      const seq1 = [r1.float(), r1.float(), r1.float(), r1.float(), r1.float()].map(n=>n.toFixed(9));
      const r2 = new RNG(baseSeed, algo);
      const seq2 = [r2.float(), r2.float(), r2.float(), r2.float(), r2.float()].map(n=>n.toFixed(9));
      log('determinism match:', JSON.stringify(seq1) === JSON.stringify(seq2) ? '✅' : '❌');
      log('seq1:', seq1.join(', '));

      const streamsA = makeTileRNG(worldSeed, shardID, x, y, algo);
      const resA = [streamsA.resources.float(), streamsA.resources.float(), streamsA.resources.float()].map(n=>n.toFixed(9));
      streamsA.mobs.float(); streamsA.mobs.float(); streamsA.mobs.float();
      const streamsB = makeTileRNG(worldSeed, shardID, x, y, algo);
      const resB = [streamsB.resources.float(), streamsB.resources.float(), streamsB.resources.float()].map(n=>n.toFixed(9));
      log('substream stability:', JSON.stringify(resA) === JSON.stringify(resB) ? '✅' : '❌');
      renderNoise(noise2D, baseSeed, freq);
    }

    document.getElementById('run').addEventListener('click', run);
    document.getElementById('noise').addEventListener('click', run);
    run().catch(err => {
      console.error(err);
      log('ERROR:', err.message);
    });
  </script>
</body>
</html>
